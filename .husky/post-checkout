#!/usr/bin/env sh
# Auto-update git submodules after checkout
# $1 = ref of previous HEAD
# $2 = ref of new HEAD
# $3 = 1 if checking out a branch, 0 if checking out a file

# Only run on branch checkout, not file checkout
if [ "$3" = "1" ]; then
  echo "Updating git submodules..."
  git submodule update --init --recursive

  # Install dependencies if switching between branches with different deps
  OLD_HEAD="$1"
  NEW_HEAD="$2"

  if [ -n "$OLD_HEAD" ] && [ -n "$NEW_HEAD" ]; then
    CHANGED_FILES=$(git diff --name-only "$OLD_HEAD" "$NEW_HEAD" 2>/dev/null || echo "")
    if echo "$CHANGED_FILES" | grep -qE "package\.json|bun\.lockb"; then
      echo "Dependencies changed, running bun install..."
      bun install
    fi
  fi
fi
